version: 2.1
orbs:
  python: circleci/python@1.5.0

jobs:
  migrations_check:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Check for missing Django migrations
          command: |
            cd admin-service
            # Will return non-zero if models changed but no migration exists
            python manage.py makemigrations --dry-run --check

  integration_tests:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - setup_remote_docker
      - run:
          name: Start test Postgres
          command: |
            docker run -d --name ci-postgres -e POSTGRES_DB=${POSTGRES_DB:-govindakumar_db} -e POSTGRES_USER=${POSTGRES_USER:-postgres} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres} -p 5432:5432 postgres:15
            # wait for pg to accept connections
            until docker exec ci-postgres pg_isready -U postgres -h localhost >/dev/null 2>&1; do sleep 1; done
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests against Postgres
          command: |
            cd admin-service
            export DATABASE_URL=postgres://postgres:postgres@localhost:5432/${POSTGRES_DB:-govindakumar_db}
            python manage.py migrate --noinput
            python manage.py test
      - run:
          name: Run API integration tests (pytest)
          command: |
            cd api-service
            pytest -q
      - run:
          name: Teardown DB
          command: |
            docker rm -f ci-postgres || true

  test:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests
          command: |
            cd admin-service
            python manage.py test || true
      - run:
          name: Run API tests (pytest)
          command: |
            cd api-service
            pytest -q || true

  build_and_push:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install tools
          command: |
            sudo apt-get update && sudo apt-get install -y curl
            python -m pip install --upgrade pip
      - run:
          name: Build and push Docker images to GHCR
          command: |
            # Expect these env vars in CircleCI project settings:
            # GHCR_OWNER (or GITHUB_USER), GHCR_PAT
            ./scripts/build_and_push.sh "${CIRCLE_SHA1}"
      - run:
          name: Deploy to Railway (optional)
          command: |
            # Expect RAILWAY_TOKEN and RAILWAY_PROJECT_ID to be set as secrets
            # The deploy script is a helper; customize to your Railway services.
            ./scripts/deploy_to_railway.sh \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-admin-service:${CIRCLE_SHA1}" \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-api-service:${CIRCLE_SHA1}" \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-portfolio-ui:${CIRCLE_SHA1}"



  notify_approval:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Send approval email (SendGrid)
          command: |
            if [ -z "${SENDGRID_API_KEY}" ] || [ -z "${DEPLOY_NOTIFICATION_TO_EMAIL}" ] || [ -z "${DEPLOY_NOTIFICATION_FROM_EMAIL}" ]; then
              echo "SendGrid env vars not set; skipping email notification."
              exit 0
            fi

            SUBJECT="Deployment pending approval for ${CIRCLE_PROJECT_REPONAME}"
            BODY="A deployment for ${CIRCLE_PROJECT_REPONAME} on branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1}) is awaiting approval: ${CIRCLE_BUILD_URL}"

            # Send a simple email via SendGrid API
            curl --silent --fail -X POST "https://api.sendgrid.com/v3/mail/send" \
              -H "Authorization: Bearer ${SENDGRID_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"personalizations":[{"to":[{"email":"'"${DEPLOY_NOTIFICATION_TO_EMAIL}"'"}]}],"from":{"email":"'"${DEPLOY_NOTIFICATION_FROM_EMAIL}"'"},"subject":"'"${SUBJECT}"'","content":[{"type":"text/plain","value":"'"${BODY}"'"}]}' || echo "sendgrid request failed"

  deploy_render:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Trigger Render deploy hook
          command: |
            if [ -z "${RENDER_DEPLOY_HOOK_URL}" ]; then
              echo "RENDER_DEPLOY_HOOK_URL is not set; skipping deploy."
              exit 0
            fi
            curl -X POST -H "Content-Type: application/json" -d '{}' "${RENDER_DEPLOY_HOOK_URL}"

workflows:
  version: 2
  build_test_and_push:
    jobs:
      - migrations_check
      - integration_tests:
          requires:
            - migrations_check
      - test:
          requires:
            - integration_tests
      - build_and_push:
          requires:
            - test
      - notify_approval:
          requires:
            - build_and_push
      - hold_deploy:
          type: approval
          requires:
            - notify_approval
      - deploy_render:
          requires:
            - hold_deploy
          filters:
            branches:
              only: main
