version: 2.1
orbs:
  python: circleci/python@1.5.0

jobs:
  migrations_check:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - setup_remote_docker
      - run:
          name: Start temporary Postgres for migration checks
          command: |
            # Use remote docker to run a disposable Postgres instance so Django can check migration history
            docker run -d --name ci-postgres-migrations -e POSTGRES_DB=${POSTGRES_DB:-govindakumar_db} -e POSTGRES_USER=${POSTGRES_USER:-postgres} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres} -p 5432:5432 postgres:15
            # wait for pg to accept connections
            until docker exec ci-postgres-migrations pg_isready -U ${POSTGRES_USER:-postgres} -h localhost >/dev/null 2>&1; do sleep 1; done
      - run:
          name: Check for missing Django migrations
          command: |
            cd admin-service
            # Point Django at the temporary postgres instance we just started
            export DATABASE_URL=postgres://postgres:postgres@localhost:5432/${POSTGRES_DB:-govindakumar_db}
            # Will return non-zero if models changed but no migration exists
            python manage.py makemigrations --dry-run --check
      - run:
          name: Teardown temporary Postgres
          command: |
            docker rm -f ci-postgres-migrations || true

  integration_tests:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - setup_remote_docker
      - run:
          name: Start test Postgres
          command: |
            docker run -d --name ci-postgres -e POSTGRES_DB=${POSTGRES_DB:-govindakumar_db} -e POSTGRES_USER=${POSTGRES_USER:-postgres} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres} -p 5432:5432 postgres:15
            # wait for pg to accept connections
            until docker exec ci-postgres pg_isready -U postgres -h localhost >/dev/null 2>&1; do sleep 1; done
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests against Postgres
          command: |
            cd admin-service
            export DATABASE_URL=postgres://postgres:postgres@localhost:5432/${POSTGRES_DB:-govindakumar_db}
            python manage.py migrate --noinput
            python manage.py test
      - run:
          name: Run API integration tests (pytest)
          command: |
            cd api-service
            pytest -q
      - run:
          name: Teardown DB
          command: |
            docker rm -f ci-postgres || true

  test:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests
          command: |
            cd admin-service
            python manage.py test || true
      - run:
          name: Run API tests (pytest)
          command: |
            cd api-service
            pytest -q || true

  build_and_push:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install tools
          command: |
            sudo apt-get update && sudo apt-get install -y curl
            python -m pip install --upgrade pip
      - run:
          name: Build and push Docker images to GHCR
          command: |
            # Expect these env vars in CircleCI project settings:
            # GHCR_OWNER (or GITHUB_USER), GHCR_PAT
            ./scripts/build_and_push.sh "${CIRCLE_SHA1}"
      - run:
          name: Deploy to Railway (optional)
          command: |
            # Expect RAILWAY_TOKEN and RAILWAY_PROJECT_ID to be set as secrets
            # The deploy script is a helper; customize to your Railway services.
            ./scripts/deploy_to_railway.sh \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-admin-service:${CIRCLE_SHA1}" \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-api-service:${CIRCLE_SHA1}" \
              "ghcr.io/${GHCR_OWNER:-${GITHUB_USER}}/${GHCR_REPO:-govindakumar}-portfolio-ui:${CIRCLE_SHA1}"



  notify_approval:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Send approval email (Brevo HTML)
          command: |
            if [ -z "${BREVO_API_KEY}" ] || [ -z "${BREVO_FROM_EMAIL}" ] || [ -z "${DEPLOY_NOTIFICATION_TO_EMAIL}" ]; then
              echo "Brevo env vars not set; skipping email notification."
              exit 0
            fi

            SUBJECT="Deployment pending approval for ${CIRCLE_PROJECT_REPONAME}"

            HTML_BODY="<html><body style=\"font-family:Arial,sans-serif;color:#111\">\
              <h2>Deployment pending approval</h2>\
              <p>A deployment for <strong>${CIRCLE_PROJECT_REPONAME}</strong> on branch <code>${CIRCLE_BRANCH}</code> (commit <code>${CIRCLE_SHA1}</code>) is awaiting your approval.</p>\
              <p><a href=\"${CIRCLE_BUILD_URL}\" style=\"display:inline-block;padding:10px 14px;background:#2563eb;color:#fff;border-radius:6px;text-decoration:none\">Open pipeline & approve</a></p>\
              <p style=\"color:#6b7280;font-size:13px\">You can approve the pipeline in CircleCI to continue with deploy. This message is automated.</p>\
            </body></html>"

            # Send with Brevo (SendinBlue) API
            PAYLOAD=$(jq -n --arg from_email "${BREVO_FROM_EMAIL}" --arg from_name "${BREVO_FROM_NAME:-GovindaKumar CI}" --arg to_email "${DEPLOY_NOTIFICATION_TO_EMAIL}" --arg subject "$SUBJECT" --arg html "$HTML_BODY" '{sender:{email:$from_email,name:$from_name},to:[{email:$to_email}],subject:$subject,htmlContent:$html}')

            curl -s -X POST "https://api.brevo.com/v3/smtp/email" \
              -H "accept: application/json" \
              -H "content-type: application/json" \
              -H "api-key: ${BREVO_API_KEY}" \
              -d "$PAYLOAD" || echo "brevo request failed"

  smoke_test:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Run smoke tests (curl /health)
          command: |
            chmod +x scripts/smoke_test.sh
            # Run tests; capture exit code but continue to send report
            ./scripts/smoke_test.sh > /tmp/smoke_report.txt || true
            cat /tmp/smoke_report.txt
            RC=$?
      - run:
          name: Send smoke test report (Brevo)
          command: |
            if [ -z "${BREVO_API_KEY}" ] || [ -z "${BREVO_FROM_EMAIL}" ] || [ -z "${DEPLOY_REPORT_EMAIL}" ]; then
              echo "Brevo or report email env vars not set; skipping report email."
              exit 0
            fi

            # Read report and sanitize for HTML
            REPORT_HTML=$(awk 'BEGIN{print "<pre style=\"font-family:monospace;white-space:pre-wrap;\">"} {gsub("&","&amp;"); gsub("<","&lt;"); gsub(">","&gt;"); print} END{print "</pre>"}' /tmp/smoke_report.txt)
            SUBJECT="Deployment report: ${CIRCLE_PROJECT_REPONAME} - $( [ -s /tmp/smoke_report.txt ] && grep -q FAIL /tmp/smoke_report.txt && echo FAILED || echo SUCCESS )"

            HTML_BODY="<html><body style=\"font-family:Arial,sans-serif;color:#111\">\
              <h2>${SUBJECT}</h2>\
              <p>Pipeline: <a href=\"${CIRCLE_BUILD_URL}\">Open in CircleCI</a></p>\
              <h3>Report</h3>\
              ${REPORT_HTML}\
            </body></html>"

            PAYLOAD=$(jq -n --arg from_email "${BREVO_FROM_EMAIL}" --arg from_name "${BREVO_FROM_NAME:-GovindaKumar CI}" --arg to_email "${DEPLOY_REPORT_EMAIL}" --arg subject "$SUBJECT" --arg html "$HTML_BODY" '{sender:{email:$from_email,name:$from_name},to:[{email:$to_email}],subject:$subject,htmlContent:$html}')

            curl -s -X POST "https://api.brevo.com/v3/smtp/email" \
              -H "accept: application/json" \
              -H "content-type: application/json" \
              -H "api-key: ${BREVO_API_KEY}" \
              -d "$PAYLOAD" || echo "brevo report request failed"

      - run:
          name: Exit with smoke test status
          command: |
            # Exit non-zero if the smoke tests failed
            if grep -q "FAIL" /tmp/smoke_report.txt; then
              echo "Smoke tests failed"
              exit 2
            fi
            echo "Smoke tests passed"
  deploy_render:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Trigger Render deploy hook
          command: |
            if [ -z "${RENDER_DEPLOY_HOOK_URL}" ]; then
              echo "RENDER_DEPLOY_HOOK_URL is not set; skipping deploy."
              exit 0
            fi
            curl -X POST -H "Content-Type: application/json" -d '{}' "${RENDER_DEPLOY_HOOK_URL}"

workflows:
  version: 2
  build_test_and_push:
    jobs:
      - migrations_check
      - integration_tests:
          requires:
            - migrations_check
      - test:
          requires:
            - integration_tests
      - build_and_push:
          requires:
            - test
      - notify_approval:
          requires:
            - build_and_push
      - hold_deploy:
          type: approval
          requires:
            - notify_approval
      - deploy_render:
          requires:
            - hold_deploy
          filters:
            branches:
              only: main
