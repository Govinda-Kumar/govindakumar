version: 2.1
orbs:
  python: circleci/python@1.5.0

jobs:
  migrations_check:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - setup_remote_docker
      - run:
          name: Start temporary Postgres for migration checks
          command: |
            # Use remote docker to run a disposable Postgres instance so Django can check migration history
            docker run -d --name ci-postgres-migrations -e POSTGRES_DB=${POSTGRES_DB:-govindakumar_db} -e POSTGRES_USER=${POSTGRES_USER:-postgres} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres} -p 5432:5432 postgres:15
            # wait for pg to accept connections
            until docker exec ci-postgres-migrations pg_isready -U ${POSTGRES_USER:-postgres} -h localhost >/dev/null 2>&1; do sleep 1; done
      - run:
          name: Check for missing Django migrations
          command: |
            cd admin-service
            # Point Django at the temporary postgres instance we just started
            export DATABASE_URL=postgres://postgres:postgres@localhost:5432/${POSTGRES_DB:-govindakumar_db}
            # Will return non-zero if models changed but no migration exists
            python manage.py makemigrations --dry-run --check
      - run:
          name: Teardown temporary Postgres
          command: |
            docker rm -f ci-postgres-migrations || true

  integration_tests:
    docker:
      - image: cimg/python:3.12
      - image: cimg/postgres:15.3
        environment:
          POSTGRES_DB: govindakumar_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Wait for Postgres
          command: |
            for i in $(seq 1 30); do
              pg_isready -h localhost -U postgres && break || sleep 1
            done
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests against Postgres
          command: |
            cd admin-service
            export DATABASE_URL=postgres://postgres:postgres@localhost:5432/${POSTGRES_DB:-govindakumar_db}
            python manage.py migrate --noinput
            python manage.py test
      - run:
          name: Run API integration tests (pytest)
          command: |
            cd api-service
            pytest -q

  test:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
            - v1-pip-cache-
      - run:
          name: Install Python deps
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r admin-service/requirements.txt
            python -m pip install -r api-service/requirements.txt
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-cache-{{ checksum "admin-service/requirements.txt" }}
      - run:
          name: Run Django tests
          command: |
            cd admin-service
            python manage.py test || true
      - run:
          name: Run API tests (pytest)
          command: |
            cd api-service
            pytest -q || true

  build_and_push:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install tools
          command: |
            sudo apt-get update && sudo apt-get install -y curl
            python -m pip install --upgrade pip
      - run:
          name: Build and push Docker images to GHCR
          command: |
            # Expect these env vars in CircleCI project settings:
            # GHCR_OWNER (or GITHUB_USER), GHCR_PAT
            ./scripts/build_and_push.sh "${CIRCLE_SHA1}"

  deploy_render:
    docker:
      - image: cimg/python:3.12
    steps:
      - checkout
      - run:
          name: Trigger Render deploy hook
          command: |
            if [ -z "${RENDER_DEPLOY_HOOK_URL}" ]; then
              echo "RENDER_DEPLOY_HOOK_URL is not set; skipping deploy."
              exit 0
            fi
            curl -X POST -H "Content-Type: application/json" -d '{}' "${RENDER_DEPLOY_HOOK_URL}"

workflows:
  version: 2
  build_test_and_push:
    jobs:
      - migrations_check
      - integration_tests:
          requires:
            - migrations_check
      - test:
          requires:
            - integration_tests
      - build_and_push:
          requires:
            - test
          filters:
            branches:
              only: main
      - deploy_render:
          requires:
            - build_and_push
          filters:
            branches:
              only: main
